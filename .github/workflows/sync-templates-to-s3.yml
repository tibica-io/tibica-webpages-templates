name: Sync Templates to S3

on:
  push:
    branches: [main]
    paths:
      - '**'  # Trigger on any file changes
  workflow_dispatch:  # Allow manual trigger

# Environment variables for the entire workflow
env:
  AWS_REGION: us-east-1
  S3_BUCKET_NAME_DEV: installator-cloud-git-dev-public-templates
  S3_BUCKET_NAME_STAGE: installator-cloud-git-stage-public-templates
  AWS_ROLE_ARN_DEV: arn:aws:iam::920367284362:role/installator-cloud-git-dev-GithubActionsTemplateBucketWriter
  AWS_ROLE_ARN_STAGE: arn:aws:iam::854027224766:role/installator-cloud-git-stage-GithubActionsTemplateBucketWriter

jobs:
  sync-templates-dev:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout templates repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials for DEV
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TemplateSync-Dev

      - name: Create templates archive for each template
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Create a temporary directory for archives
          mkdir -p archives

          # List of template directories
          TEMPLATES=(
            "angular"
            "astro-blog"
            "astro-portfolio"
            "eleventy-blog"
            "email-signature-generator"
            "html-static"
            "preact-vite"
            "preact-vite-ts"
            "react-cra"
            "react-cra-ts"
            "react-docs-advanced"
            "react-vite"
            "react-vite-ts"
            "svelte"
            "svelte-ts"
            "svelte-vite"
            "svelte-vite-ts"
            "vanilla-vite"
            "vanilla-vite-ts"
            "vitepress-docs"
            "vue"
            "vue-ts"
            "vue-vite"
            "vue-vite-ts"
          )

          # Create archives for each template
          for template in "${TEMPLATES[@]}"; do
            if [ -d "$template" ]; then
              # Get mapped name from template-mapping.json
              mapped_name=$(jq -r --arg key "$template" '.[$key] // empty' template-mapping.json)
              
              # Use mapped name if exists, otherwise use original name
              archive_name=${mapped_name:-$template}
              
              echo "Creating archive for $template as $archive_name..."
              # Create zip archive excluding .git and node_modules
              cd "$template"
              zip -r "../archives/${archive_name}.zip" . \
                -x "*.git*" \
                -x "*node_modules*" \
                -x "*.DS_Store*" \
                -x "*dist/*" \
                -x "*build/*" \
                -x "*.next/*" \
                -x "*coverage/*"
              cd ..
              echo "Archive created: archives/${archive_name}.zip"
            else
              echo "Warning: Template directory $template not found"
            fi
          done

      - name: Upload archives to S3 DEV
        run: |
          # Upload each archive to S3 DEV
          aws s3 sync archives/ s3://${{ env.S3_BUCKET_NAME_DEV }}/templates/ \
            --delete \
            --exclude "*" \
            --include "*.zip"

          echo "Templates uploaded to S3 DEV bucket: ${{ env.S3_BUCKET_NAME_DEV }}"

      - name: Create and upload templates index for DEV
        run: |
          # Create a JSON index of all available templates
          cat > templates-index-dev.json << EOF
          {
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "environment": "dev",
            "templates": [
          EOF

          # Add each template to the index
          first=true
          for archive in archives/*.zip; do
            if [ -f "$archive" ]; then
              filename=$(basename "$archive" .zip)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> templates-index-dev.json
              fi
              cat >> templates-index-dev.json << EOF
              {
                "name": "$filename",
                "downloadUrl": "https://${{ env.S3_BUCKET_NAME_DEV }}.s3.amazonaws.com/templates/$filename.zip",
                "size": $(stat -c%s "$archive" 2>/dev/null || stat -f%z "$archive")
              }
          EOF
            fi
          done

          cat >> templates-index-dev.json << EOF
            ]
          }
          EOF

          # Upload the index file to templates/ prefix to match S3 permissions
          aws s3 cp templates-index-dev.json s3://${{ env.S3_BUCKET_NAME_DEV }}/templates/index.json \
            --content-type "application/json"

          echo "Templates index uploaded to S3 DEV"

  sync-templates-stage:
    runs-on: ubuntu-latest
    needs: sync-templates-dev
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout templates repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials for STAGE
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN_STAGE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TemplateSync-Stage
        continue-on-error: true
        id: oidc-stage

      - name: Configure AWS credentials for STAGE (fallback)
        if: steps.oidc-stage.outcome == 'failure'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGE }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create templates archive for each template
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Create a temporary directory for archives
          mkdir -p archives

          # List of template directories
          TEMPLATES=(
            "angular"
            "astro-blog"
            "astro-portfolio"
            "eleventy-blog"
            "email-signature-generator"
            "html-static"
            "preact-vite"
            "preact-vite-ts"
            "react-cra"
            "react-cra-ts"
            "react-docs-advanced"
            "react-vite"
            "react-vite-ts"
            "svelte"
            "svelte-ts"
            "svelte-vite"
            "svelte-vite-ts"
            "vanilla-vite"
            "vanilla-vite-ts"
            "vitepress-docs"
            "vue"
            "vue-ts"
            "vue-vite"
            "vue-vite-ts"
          )

          # Create archives for each template
          for template in "${TEMPLATES[@]}"; do
            if [ -d "$template" ]; then
              # Get mapped name from template-mapping.json
              mapped_name=$(jq -r --arg key "$template" '.[$key] // empty' template-mapping.json)
              
              # Use mapped name if exists, otherwise use original name
              archive_name=${mapped_name:-$template}
              
              echo "Creating archive for $template as $archive_name..."
              # Create zip archive excluding .git and node_modules
              cd "$template"
              zip -r "../archives/${archive_name}.zip" . \
                -x "*.git*" \
                -x "*node_modules*" \
                -x "*.DS_Store*" \
                -x "*dist/*" \
                -x "*build/*" \
                -x "*.next/*" \
                -x "*coverage/*"
              cd ..
              echo "Archive created: archives/${archive_name}.zip"
            else
              echo "Warning: Template directory $template not found"
            fi
          done

      - name: Upload archives to S3 STAGE
        run: |
          # Upload each archive to S3 STAGE
          aws s3 sync archives/ s3://${{ env.S3_BUCKET_NAME_STAGE }}/templates/ \
            --delete \
            --exclude "*" \
            --include "*.zip"

          echo "Templates uploaded to S3 STAGE bucket: ${{ env.S3_BUCKET_NAME_STAGE }}"

      - name: Create and upload templates index for STAGE
        run: |
          # Create a JSON index of all available templates
          cat > templates-index-stage.json << EOF
          {
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "environment": "stage",
            "templates": [
          EOF

          # Add each template to the index
          first=true
          for archive in archives/*.zip; do
            if [ -f "$archive" ]; then
              filename=$(basename "$archive" .zip)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> templates-index-stage.json
              fi
              cat >> templates-index-stage.json << EOF
              {
                "name": "$filename",
                "downloadUrl": "https://${{ env.S3_BUCKET_NAME_STAGE }}.s3.amazonaws.com/templates/$filename.zip",
                "size": $(stat -c%s "$archive" 2>/dev/null || stat -f%z "$archive")
              }
          EOF
            fi
          done

          cat >> templates-index-stage.json << EOF
            ]
          }
          EOF

          # Upload the index file to templates/ prefix to match S3 permissions
          aws s3 cp templates-index-stage.json s3://${{ env.S3_BUCKET_NAME_STAGE }}/templates/index.json \
            --content-type "application/json"

          echo "Templates index uploaded to S3 STAGE"

      - name: Summary
        run: |
          echo "âœ… Template sync completed successfully!"
          echo "ğŸ“¦ DEV Archives uploaded to: s3://${{ env.S3_BUCKET_NAME_DEV }}/templates/"
          echo "ğŸ“¦ STAGE Archives uploaded to: s3://${{ env.S3_BUCKET_NAME_STAGE }}/templates/"
          echo "ğŸ“‹ DEV Index file: s3://${{ env.S3_BUCKET_NAME_DEV }}/templates/index.json"
          echo "ğŸ“‹ STAGE Index file: s3://${{ env.S3_BUCKET_NAME_STAGE }}/templates/index.json"
          echo "ğŸ”— Commit: ${{ github.sha }}"
